{% extends "base.html" %}
{% load static %}
{% load attendance_extras %}

{% block title %}Location Dashboard - Road Attendance System{% endblock %}

{% block secondary_nav %}
{% include 'secondary_nav.html' %}
{% block secondary_nav_tabs %}
<a href="{% url 'location_dashboard' %}" class="secondary-nav-tab {% if request.resolver_match.url_name == 'location_dashboard' %}active{% endif %}">
    üìç Dashboard
</a>
<a href="{% url 'location_assignment_list' %}" class="secondary-nav-tab {% if request.resolver_match.url_name == 'location_assignment_list' %}active{% endif %}">
    üìã Assignments
</a>
{% endblock %}
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="dashboard-header">
        <h1 class="dashboard-title">üìç Location Dashboard</h1>
        <p class="dashboard-subtitle">Real-time location tracking and assignment management</p>
        
        <div class="controls-section">
            <div class="control-group">
                <button onclick="location.reload()" class="refresh-btn">üîÑ Refresh Data</button>
            </div>
        </div>
    </div>
    
    <!-- Summary Cards -->
    <div class="card-grid">
        <div class="card">
            <div class="card-value text-primary">{{ total_assignments }}</div>
            <div class="card-label">Total Assignments</div>
        </div>
        <div class="card">
            <div class="card-value text-success">{{ total_employees }}</div>
            <div class="card-label">Active Employees</div>
        </div>
        <div class="card">
            <div class="card-value text-warning">{{ avg_utilization|floatformat:1 }}%</div>
            <div class="card-label">Avg Utilization</div>
        </div>
        <div class="card">
            <div class="card-value text-primary">{{ locations|length }}</div>
            <div class="card-label">Active Locations</div>
        </div>
    </div>
    
    <!-- Location Status -->
    <div class="section">
        <div class="section-header">
            <h3 class="section-title">üìç Location Status</h3>
        </div>
        <div class="section-body">
            {% if locations %}
            <div class="card-grid">
                {% for location in locations %}
                <div class="card">
                    <div class="card-value">{{ location.name }}</div>
                    <div class="card-label">Location</div>
                    
                    <div style="margin-top: 1rem;">
                        <div style="font-size: 0.9rem; color: var(--text-secondary);">
                            <strong>Capacity:</strong> {{ location.capacity }}
                        </div>
                        <div style="font-size: 0.9rem; color: var(--text-secondary);">
                            <strong>Current Occupancy:</strong> {{ location.current_occupancy }}
                        </div>
                        <div style="font-size: 0.9rem; color: var(--text-secondary);">
                            <strong>Utilization Rate:</strong> {{ location.utilization_rate|floatformat:1 }}%
                        </div>
                    </div>
                    
                    <div style="margin-top: 1rem;">
                        <span class="status-badge status-active">Active</span>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                <p>No active locations today</p>
            </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Recent Activity -->
    <div class="section">
        <div class="section-header">
            <h3 class="section-title">üìã Recent Assignments</h3>
        </div>
        <div class="section-body">
            {% if recent_assignments %}
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Employee</th>
                            <th>Location</th>
                            <th>Task Type</th>
                            <th>Assigned Date</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for assignment in recent_assignments %}
                        <tr>
                            <td>
                                <strong>{{ assignment.employee.given_name }} {{ assignment.employee.surname }}</strong>
                                <br>
                                <small>
                                    {% if assignment.employee.card_number %}
                                        {{ assignment.employee.card_number.designation|get_department_from_designation }}
                                    {% else %}
                                        No Department
                                    {% endif %}
                                </small>
                            </td>
                            <td>{{ assignment.location.name }}</td>
                            <td>{{ assignment.task_type|default:"General Assignment" }}</td>
                            <td>{{ assignment.assigned_date|date:"M d, Y" }}</td>
                            <td>
                                <span class="status-badge status-{{ assignment.status }}">
                                    {{ assignment.get_status_display }}
                                </span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                <p>No recent assignments</p>
            </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Recent Movements -->
    <div class="section">
        <div class="section-header">
            <h3 class="section-title">üö∂ Recent Movements</h3>
        </div>
        <div class="section-body">
            {% if recent_movements %}
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Employee</th>
                            <th>Movement Type</th>
                            <th>To Location</th>
                            <th>Timestamp</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for movement in recent_movements %}
                        <tr>
                            <td>
                                <strong>{{ movement.employee.given_name }} {{ movement.employee.surname }}</strong>
                                <br>
                                <small>
                                    {% if movement.employee.card_number %}
                                        {{ movement.employee.card_number.designation|get_department_from_designation }}
                                    {% else %}
                                        No Department
                                    {% endif %}
                                </small>
                            </td>
                            <td>{{ movement.movement_type|title }}</td>
                            <td>{{ movement.to_location.name }}</td>
                            <td>{{ movement.timestamp|date:"M d, H:i" }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                <p>No recent movements</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %} 