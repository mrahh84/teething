{% extends "reports/base.html" %}

{% block reports_content %}
<div class="attendance-card">
    <div class="card-header">
        <h2>ðŸ“Š Comprehensive Reports Dashboard</h2>
        <p style="margin: 0; color: #6c757d;">Interactive analytics and reports for attendance tracking</p>
    </div>
    <div class="card-body">
        <!-- Date Range and Department Filter -->
        <form method="get" class="filter-form">
            <div class="field-group">
                <div>
                    <label for="start_date">Start Date</label>
                    <input type="date" name="start_date" value="{{ start_date }}" class="form-control">
                </div>
                <div>
                    <label for="end_date">End Date</label>
                    <input type="date" name="end_date" value="{{ end_date }}" class="form-control">
                </div>
                <div>
                    <label for="department">Department:</label>
                    <select id="department" name="department" class="form-control">
                        <option value="">All Departments</option>
                        {% for dept in available_departments %}
                        <option value="{{ dept }}" {% if department_filter == dept %}selected{% endif %}>{{ dept }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <button type="submit" class="btn btn-primary">ðŸ”„ Update Report</button>
                </div>
            </div>
        </form>

        <!-- Comprehensive Attendance Report iframe -->
        <div class="marimo-container">
            <div style="margin-bottom: 10px; text-align: right;">
                <button onclick="refreshIframe()" class="btn btn-sm btn-outline-secondary">ðŸ”„ Refresh Report</button>
            </div>
            <iframe 
                id="comprehensive-attendance-iframe"
                src="{% url 'comprehensive_attendance_report' %}?start_date={{ start_date }}&end_date={{ end_date }}{% if department_filter %}&department={{ department_filter }}{% endif %}&iframe=1&v={{ timestamp|default:'' }}"
                width="100%" 
                height="800px" 
                frameborder="0"
                title="Comprehensive Attendance Report">
            </iframe>
        </div>
        
        <script>
        // Refresh iframe function
        function refreshIframe() {
            const iframe = document.getElementById('comprehensive-attendance-iframe');
            if (iframe) {
                const currentSrc = iframe.src;
                const separator = currentSrc.includes('?') ? '&' : '?';
                iframe.src = currentSrc + separator + 'refresh=' + Date.now();
            }
        }
        
        // Force iframe refresh when page loads
        document.addEventListener('DOMContentLoaded', function() {
            const iframe = document.getElementById('comprehensive-attendance-iframe');
            if (iframe) {
                // Add a small delay to ensure the iframe is loaded
                setTimeout(function() {
                    iframe.src = iframe.src + '&refresh=' + Date.now();
                }, 100);
            }
        });
        </script>
    </div>
</div>
{% endblock %} 