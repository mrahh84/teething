{% extends "attendance/base.html" %}
{% load static %}

{% block attendance_content %}
<div class="attendance-card">
    <div class="card-header">
        <h2>üìä Progressive Entry</h2>
        <p style="margin: 0; color: rgba(255,255,255,0.9);">Enter attendance data progressively for employees who clocked in today</p>
    </div>
    
    <div class="card-body">
        <!-- Filter Controls -->
        <div class="filter-section">
            <h3>üîç Filter Controls</h3>
            <form method="get" class="filter-form">
                <div class="form-group">
                    <label for="department">Department</label>
                    <select name="department" id="department" onchange="this.form.submit()" class="form-control">
                        <option value="">All Departments</option>
                        {% for dept in available_departments %}
                        <option value="{{ dept }}" {% if department_filter == dept %}selected{% endif %}>{{ dept }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label for="start_letter">Start Letter</label>
                    <select name="start_letter" id="start_letter" onchange="this.form.submit()" class="form-control">
                        <option value="all">All Letters</option>
                        {% for letter in "ABCDEFGHIJKLMNOPQRSTUVWXYZ" %}
                        <option value="{{ letter }}" {% if start_letter == letter %}selected{% endif %}>{{ letter }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label for="search">Search</label>
                    <input type="text" name="search" id="search" value="{{ search_query }}" placeholder="Search by name or designation" class="form-control">
                </div>
                <div class="form-group">
                    <button type="submit" class="btn btn-primary">üîç Apply Filters</button>
                    <a href="{% url 'progressive_entry' %}" class="btn btn-secondary">üóëÔ∏è Clear</a>
                </div>
            </form>
        </div>
        
        <!-- Employee Attendance List -->
        <div class="employee-section">
            <h3>üë• Employee Attendance - {{ today|date:"l, F d, Y" }}</h3>
            <p style="margin: 0 0 20px 0; color: #6c757d;">Showing {{ employee_attendance|length }} employees who clocked in today</p>
            
            {% if employee_attendance %}
            <div class="table-responsive">
                <table class="attendance-table">
                    <thead>
                        <tr>
                            <th>Employee</th>
                            <th>Clock In/Out Time</th>
                            <th>Stand-up</th>
                            <th>Lunch Time</th>
                            <th>Left On Time</th>
                            <th>Returned On Time</th>
                            <th>Notes</th>
                            <th>Status</th>
                            <th>Completion</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in employee_attendance %}
                        <tr data-employee-id="{{ item.employee.id }}">
                            <td>
                                <strong>{{ item.employee.given_name }} {{ item.employee.surname }}</strong>
                                <br><small>{{ item.employee.card_number.designation|default:"No Designation" }}</small>
                            </td>
                            <td>
                                {% if item.arrival_time %}
                                    <strong>In:</strong> {{ item.arrival_time|time:"H:i" }}<br>
                                {% endif %}
                                {% if item.departure_time %}
                                    <strong>Out:</strong> {{ item.departure_time|time:"H:i" }}
                                {% endif %}
                                {% if not item.arrival_time and not item.departure_time %}
                                    <em>No clock events</em>
                                {% endif %}
                            </td>
                            <td>
                                <select class="inline-select" data-field="standup_attendance" data-employee-id="{{ item.employee.id }}" onchange="updateField(this)">
                                    <option value="">-</option>
                                    <option value="YES" {% if item.record.standup_attendance == 'YES' %}selected{% endif %}>‚úÖ Yes</option>
                                    <option value="NO" {% if item.record.standup_attendance == 'NO' %}selected{% endif %}>‚ùå No</option>
                                    <option value="LATE" {% if item.record.standup_attendance == 'LATE' %}selected{% endif %}>‚è∞ Late</option>
                                    <option value="ABSENT" {% if item.record.standup_attendance == 'ABSENT' %}selected{% endif %}>üö´ Absent</option>
                                </select>
                            </td>
                            <td>
                                <select class="inline-select" data-field="lunch_time" data-employee-id="{{ item.employee.id }}" onchange="updateField(this)">
                                    <option value="">-</option>
                                    <option value="12:00" {% if item.record.lunch_time and item.record.lunch_time|time:'H:i' == '12:00' %}selected{% endif %}>12:00</option>
                                    <option value="12:30" {% if item.record.lunch_time and item.record.lunch_time|time:'H:i' == '12:30' %}selected{% endif %}>12:30</option>
                                    <option value="13:00" {% if item.record.lunch_time and item.record.lunch_time|time:'H:i' == '13:00' %}selected{% endif %}>13:00</option>
                                </select>
                            </td>
                            <td>
                                <select class="inline-select" data-field="left_lunch_on_time" data-employee-id="{{ item.employee.id }}" onchange="updateField(this)">
                                    <option value="">-</option>
                                    <option value="YES" {% if item.record.left_lunch_on_time == 'YES' %}selected{% endif %}>‚úÖ Yes</option>
                                    <option value="NO" {% if item.record.left_lunch_on_time == 'NO' %}selected{% endif %}>‚ùå No</option>
                                    <option value="LATE" {% if item.record.left_lunch_on_time == 'LATE' %}selected{% endif %}>‚è∞ Late</option>
                                    <option value="ABSENT" {% if item.record.left_lunch_on_time == 'ABSENT' %}selected{% endif %}>üö´ Absent</option>
                                </select>
                            </td>
                            <td>
                                <select class="inline-select" data-field="returned_on_time_after_lunch" data-employee-id="{{ item.employee.id }}" onchange="updateField(this)">
                                    <option value="">-</option>
                                    <option value="YES" {% if item.record.returned_on_time_after_lunch == 'YES' %}selected{% endif %}>‚úÖ Yes</option>
                                    <option value="NO" {% if item.record.returned_on_time_after_lunch == 'NO' %}selected{% endif %}>‚ùå No</option>
                                    <option value="LATE" {% if item.record.returned_on_time_after_lunch == 'LATE' %}selected{% endif %}>‚è∞ Late</option>
                                    <option value="ABSENT" {% if item.record.returned_on_time_after_lunch == 'ABSENT' %}selected{% endif %}>üö´ Absent</option>
                                </select>
                            </td>
                            <td>
                                <textarea class="notes-field" data-field="notes" data-employee-id="{{ item.employee.id }}" 
                                    placeholder="Enter notes..." onblur="updateField(this)" 
                                    style="width: 100px; height: 40px; font-size: 0.8rem; resize: none;">{{ item.record.notes|default:"" }}</textarea>
                            </td>
                            <td>
                                <span class="status-badge status-{{ item.record.status|lower|default:'pending' }}" id="status-{{ item.employee.id }}">
                                    {{ item.record.get_status_display|default:"Pending" }}
                                </span>
                            </td>
                            <td>
                                <div class="completion-bar">
                                    <div class="completion-fill" id="completion-{{ item.employee.id }}" style="width: {{ item.record.completion_percentage|default:0 }}%"></div>
                                    <span class="completion-text">{{ item.record.completion_percentage|default:0 }}%</span>
                                </div>
                            </td>
                            <td>
                                <button class="btn btn-primary btn-sm" onclick="saveEmployee({{ item.employee.id }})">üíæ Save</button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div style="text-align: center; padding: 2rem; color: #6c757d;">
                <p>No employees found matching your criteria.</p>
                <p>Only employees who clocked in today are shown.</p>
            </div>
            {% endif %}
        </div>
        
        <!-- Batch Actions -->
        {% if employee_attendance %}
        <div class="batch-actions">
            <h3>üîÑ Batch Actions</h3>
            <div class="batch-buttons">
                <button class="btn btn-success" onclick="batchUpdate('standup_attendance', 'YES')">‚úÖ Mark All Stand-up Yes</button>
                <button class="btn btn-warning" onclick="batchUpdate('standup_attendance', 'LATE')">‚è∞ Mark All Stand-up Late</button>
                <button class="btn btn-danger" onclick="batchUpdate('standup_attendance', 'NO')">‚ùå Mark All Stand-up No</button>
                <button class="btn btn-success" onclick="batchUpdate('left_lunch_on_time', 'YES')">‚úÖ Mark All Left On Time</button>
                <button class="btn btn-success" onclick="batchUpdate('returned_on_time_after_lunch', 'YES')">‚úÖ Mark All Returned On Time</button>
                <button class="btn btn-primary" onclick="saveAll()">üíæ Save All Changes</button>
            </div>
        </div>
        {% endif %}
    </div>
</div>



<script>
// Track changes for each employee
const changes = new Map();
let isProcessing = false;

// Update field with AJAX
function updateField(element) {
    const employeeId = element.dataset.employeeId;
    const fieldName = element.dataset.field;
    const fieldValue = element.value || element.textContent;
    
    // Mark as changed
    element.classList.add('changed');
    element.classList.remove('saving');
    
    // Store change
    if (!changes.has(employeeId)) {
        changes.set(employeeId, {});
    }
    changes.get(employeeId)[fieldName] = fieldValue;
    
    // Auto-save after 2 seconds
    setTimeout(() => {
        if (element.classList.contains('changed')) {
            saveField(employeeId, fieldName, fieldValue);
        }
    }, 2000);
}

// Save individual field
async function saveField(employeeId, fieldName, fieldValue) {
    const element = document.querySelector(`[data-employee-id="${employeeId}"][data-field="${fieldName}"]`);
    
    try {
        element.classList.remove('changed');
        element.classList.add('saving');
        
        const response = await fetch('{% url "progressive_entry" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: `employee_id=${employeeId}&field_name=${fieldName}&field_value=${fieldValue}`
        });
        
        const data = await response.json();
        
        if (data.success) {
            element.classList.remove('saving');
            
            // Update status and completion
            const statusElement = document.getElementById(`status-${employeeId}`);
            const completionElement = document.getElementById(`completion-${employeeId}`);
            
            if (statusElement) {
                statusElement.textContent = data.status;
                statusElement.className = `status-badge status-${data.status.toLowerCase()}`;
            }
            
            if (completionElement) {
                completionElement.style.width = data.completion + '%';
                completionElement.nextElementSibling.textContent = data.completion + '%';
            }
            
            // Remove from changes
            if (changes.has(employeeId)) {
                delete changes.get(employeeId)[fieldName];
                if (Object.keys(changes.get(employeeId)).length === 0) {
                    changes.delete(employeeId);
                }
            }
        } else {
            element.classList.remove('saving');
            element.classList.add('changed');
            alert('Error: ' + data.error);
        }
    } catch (error) {
        element.classList.remove('saving');
        element.classList.add('changed');
        alert('Network error while saving');
    }
}

// Save all changes for an employee
async function saveEmployee(employeeId) {
    if (!changes.has(employeeId)) {
        alert('No changes to save');
        return;
    }
    
    const employeeChanges = changes.get(employeeId);
    const changeData = [];
    
    for (const [fieldName, fieldValue] of Object.entries(employeeChanges)) {
        changeData.push(`${fieldName}=${fieldValue}`);
    }
    
    try {
        const response = await fetch('{% url "progressive_entry" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: `employee_id=${employeeId}&${changeData.join('&')}`
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Update all fields for this employee
            for (const [fieldName, fieldValue] of Object.entries(employeeChanges)) {
                const element = document.querySelector(`[data-employee-id="${employeeId}"][data-field="${fieldName}"]`);
                if (element) {
                    element.classList.remove('changed', 'saving');
                }
            }
            
            // Update status and completion
            const statusElement = document.getElementById(`status-${employeeId}`);
            const completionElement = document.getElementById(`completion-${employeeId}`);
            
            if (statusElement) {
                statusElement.textContent = data.status;
                statusElement.className = `status-badge status-${data.status.toLowerCase()}`;
            }
            
            if (completionElement) {
                completionElement.style.width = data.completion + '%';
                completionElement.nextElementSibling.textContent = data.completion + '%';
            }
            
            changes.delete(employeeId);
            alert('Employee data saved successfully');
        } else {
            alert('Error: ' + data.error);
        }
    } catch (error) {
        alert('Network error while saving');
    }
}

// Batch update all employees
async function batchUpdate(fieldName, fieldValue) {
    const elements = document.querySelectorAll(`[data-field="${fieldName}"]`);
    let updatedCount = 0;
    
    for (const element of elements) {
        if (element.tagName === 'SELECT') {
            element.value = fieldValue;
        } else if (element.tagName === 'TEXTAREA') {
            element.value = fieldValue;
        }
        element.classList.add('changed');
        
        const employeeId = element.dataset.employeeId;
        if (!changes.has(employeeId)) {
            changes.set(employeeId, {});
        }
        changes.get(employeeId)[fieldName] = fieldValue;
        updatedCount++;
    }
    
    alert(`Updated ${updatedCount} employees. Click "Save All Changes" to persist the changes.`);
}

// Save all changes
async function saveAll() {
    if (changes.size === 0) {
        alert('No changes to save');
        return;
    }
    
    const batchData = [];
    for (const [employeeId, employeeChanges] of changes.entries()) {
        for (const [fieldName, fieldValue] of Object.entries(employeeChanges)) {
            batchData.push(`changes[${employeeId}][${fieldName}]=${fieldValue}`);
        }
    }
    
    try {
        const response = await fetch('{% url "progressive_entry" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: `batch_update=true&${batchData.join('&')}`
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Clear all changes
            changes.clear();
            
            // Remove changed classes from all elements
            document.querySelectorAll('.inline-select.changed, .notes-field.changed').forEach(element => {
                element.classList.remove('changed');
            });
            
            // Update completions
            for (const [employeeId, completion] of Object.entries(data.completions)) {
                const completionElement = document.getElementById(`completion-${employeeId}`);
                if (completionElement) {
                    completionElement.style.width = completion + '%';
                    completionElement.nextElementSibling.textContent = completion + '%';
                }
            }
            
            alert(`Batch update completed: ${data.message}`);
        } else {
            alert('Error: ' + data.error);
        }
    } catch (error) {
        alert('Network error while saving');
    }
}

// Add CSRF token to all forms
document.addEventListener('DOMContentLoaded', function() {
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    document.querySelectorAll('form').forEach(form => {
        if (!form.querySelector('[name=csrfmiddlewaretoken]')) {
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrfmiddlewaretoken';
            csrfInput.value = csrfToken;
            form.appendChild(csrfInput);
        }
    });
});
</script>
{% endblock %} 